<!DOCTYPE html>
<html>
<head>
  <title>Location-Based Attendance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    #formLink {
      display: none;
      font-size: 18px;
      color: blue;
      text-decoration: underline;
      cursor: pointer;
      opacity: 0.5;
      pointer-events: none;
    }
    #confirmBox {
      display: none;
      margin-top: 20px;
      font-size: 16px;
    }
    #leaveSection {
      margin-top: 50px;
    }
  </style>
</head>

<body>
  <h2>üîÑ Fetching your location...</h2>
  <p id="status">Please wait while we capture your location.</p>

  <!-- Checkbox -->
  <div id="confirmBox">
    <label>
      <input type="checkbox" id="confirmCheck">
      I confirm I am present at the location
    </label>
  </div>

  <!-- Form Link -->
  <a id="formLink" href="#" target="_blank">
    üöÄ Click Here to Submit Check‚ÄëIn
  </a>

  <!-- Leave Form -->
  <div id="leaveSection">
    <h3>üìå Leave Application:</h3>
    <a href="https://docs.google.com/forms/d/e/1FAIpQLSdLhIjjSMSPMalr0Hanbb7idXZ0GhDxkNnby9U-5Ja83UbWZg/viewform"
       target="_blank">üìù Submit Leave Form</a>
  </div>

<script>
/* ---------------- CONFIG ---------------- */
const targetLat = 28.868918;
const targetLon = 77.111913;
const radiusInMeters = 200;
const ONE_HOUR = 4 * 60 * 60 * 1000;
const STORAGE_KEY = "lastCheckInTime";

/* --------- HELPER FUNCTIONS --------- */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function randomCode() {
  return Math.floor(100 + Math.random()*900) + "-CHK-" + Date.now().toString().slice(-4);
}

/* --------- MAIN LOGIC --------- */
function startCheckIn() {

  const lastTime = localStorage.getItem(STORAGE_KEY);
  const now = Date.now();

  if (lastTime && (now - lastTime) < ONE_HOUR) {
    document.querySelector("h2").innerText = "‚è≥ Check‚ÄëIn Already Done";
    document.getElementById("status").innerText = "Try again after some time.";
    return;
  }

  if (!navigator.geolocation) {
    document.getElementById("status").innerText = "Geolocation not supported.";
    return;
  }

  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    const distance = getDistance(lat, lon, targetLat, targetLon);

    if (distance <= radiusInMeters) {

      document.querySelector("h2").innerText = "‚úÖ Location Verified";
      document.getElementById("status").innerText =
        `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;

      const code = randomCode();
      const formBase =
        "https://docs.google.com/forms/d/e/1FAIpQLSdeBpg9REgKjth9psQm19Pn8sVWqRq9yyv9mZ2eN3otb5PGWw/viewform?usp=pp_url";

      const finalLink =
        `${formBase}&entry.2007994588=${lat.toFixed(6)}&entry.1088348376=${lon.toFixed(6)}&entry.1749849562=${code}`;

      const link = document.getElementById("formLink");
      link.href = finalLink;
      link.innerText = `üöÄ Submit Check‚ÄëIn (Code: ${code})`;
      link.style.display = "inline";

      document.getElementById("confirmBox").style.display = "block";

      document.getElementById("confirmCheck").addEventListener("change", function () {
        if (this.checked) {
          link.style.pointerEvents = "auto";
          link.style.opacity = "1";
          localStorage.setItem(STORAGE_KEY, Date.now());
        } else {
          link.style.pointerEvents = "none";
          link.style.opacity = "0.5";
        }
      });

    } else {
      document.querySelector("h2").innerText = "‚ùå Outside Allowed Area";
      document.getElementById("status").innerText =
        `You are ${Math.round(distance)} meters away.`;
    }

  }, err => {
    document.getElementById("status").innerText = err.message;
  }, {
    enableHighAccuracy: true,
    timeout: 15000
  });
}

startCheckIn();
</script>

</body>
</html>

